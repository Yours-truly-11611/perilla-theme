{{ define "main" }}
{{ $heroImage := .Params.heroImage | default "images/backgrounds/bathing.jpg" }}
{{ $heroTint := .Params.heroTintColor | default "rgba(30, 20, 40, 0.55)" }}

{{ if .Params.heroFull }}
<section class="hero" aria-label="{{ .Title }} hero">
  <div class="hero__bg"
       style="background-image: url('{{ $heroImage | relURL }}');
              background-color: {{ $heroTint }};">
  </div>
  <div class="hero__content">
    <h1 class="hero__title">{{ .Title }}</h1>
    {{ with .Params.heroSubtitle }}
      <p class="hero__subtitle">{{ . }}</p>
    {{ end }}
  </div>
  <a href="#page-content" class="hero__scroll-hint" aria-label="Scroll to content">
    <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
  </a>
</section>
{{ else }}
<section class="hero-split" aria-label="{{ .Title }} hero">
  <div class="hero-split__title-block">
    <h1 class="hero-split__title">{{ .Title }}</h1>
    {{ with .Params.heroSubtitle }}
      <p class="hero-split__subtitle">{{ . }}</p>
    {{ end }}
  </div>
  <div class="hero-split__image" role="button" tabindex="0" aria-label="View full image">
    <img src="{{ $heroImage | relURL }}" alt="{{ .Title }}" />
  </div>
</section>

<div class="lightbox" id="lightbox" aria-hidden="true">
  <div class="lightbox__backdrop"></div>
  <div class="lightbox__content">
    <img class="lightbox__img" src="{{ $heroImage | relURL }}" alt="{{ .Title }}" />
    {{ with .Params.heroImageDesc }}<p class="lightbox__caption">{{ . }}</p>{{ end }}
  </div>
</div>
{{ end }}

{{/* Blog tab bar â€” attached to bottom of hero */}}
{{ if or (eq .Section "blog") (eq .Type "blog") }}
  {{ partial "blog-tabs.html" . }}
{{ end }}

<main id="page-content" class="site-content">
  <div class="container">

    {{/* Popular section: filter to only popular posts */}}
    {{ if eq .RelPermalink "/blog/popular/" }}
    <div class="post-grid">
      {{ $blogPage := .Site.GetPage "/blog" }}
      {{ range where $blogPage.Pages "Params.popular" true }}
        <a href="{{ .Permalink }}" class="post-card" data-reveal>
          {{ with .Params.image }}
            <div class="post-card__image">
              <img src="{{ . }}" alt="{{ $.Title }}" loading="lazy" />
            </div>
          {{ end }}
          <div class="post-card__body">
            <time class="post-card__date" datetime="{{ .Date.Format "2006-01-02" }}">
              {{ .Date.Format "January 2, 2006" }}
            </time>
            <h2 class="post-card__title">{{ .Title }}</h2>
            {{ with .Summary }}
              <p class="post-card__summary">{{ . }}</p>
            {{ end }}
          </div>
        </a>
      {{ else }}
        <p class="blog-tabs__empty">No popular posts yet.</p>
      {{ end }}
    </div>
    {{ else }}
    <div class="post-grid">
      {{ range .Pages }}
        <a href="{{ .Permalink }}" class="post-card" data-reveal>
          {{ with .Params.image }}
            <div class="post-card__image">
              <img src="{{ . }}" alt="{{ $.Title }}" loading="lazy" />
            </div>
          {{ end }}
          <div class="post-card__body">
            <time class="post-card__date" datetime="{{ .Date.Format "2006-01-02" }}">
              {{ .Date.Format "January 2, 2006" }}
            </time>
            <h2 class="post-card__title">{{ .Title }}</h2>
            {{ with .Summary }}
              <p class="post-card__summary">{{ . }}</p>
            {{ end }}
          </div>
        </a>
      {{ end }}
    </div>
    {{ end }}{{/* end popular vs normal */}}
  </div>
</main>

<script>
(function () {
  var cards = document.querySelectorAll('[data-reveal]');
  if (!cards.length) return;

  var observer = new IntersectionObserver(function (entries) {
    entries.forEach(function (entry) {
      if (entry.isIntersecting) {
        entry.target.classList.add('is-visible');
        observer.unobserve(entry.target);
      }
    });
  }, { threshold: 0.1 });

  cards.forEach(function (card) {
    observer.observe(card);
  });
})();

// Lightbox
(function () {
  var trigger = document.querySelector('.hero-split__image');
  var lightbox = document.getElementById('lightbox');
  if (!trigger || !lightbox) return;

  function open() {
    lightbox.classList.add('is-active');
    lightbox.setAttribute('aria-hidden', 'false');
  }
  function close() {
    lightbox.classList.remove('is-active');
    lightbox.setAttribute('aria-hidden', 'true');
  }

  trigger.addEventListener('click', open);
  trigger.addEventListener('keydown', function (e) {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); open(); }
  });
  lightbox.querySelector('.lightbox__backdrop').addEventListener('click', close);
  lightbox.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') close();
  });
})();
</script>
{{ end }}
